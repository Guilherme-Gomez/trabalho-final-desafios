---
title: "Desafios e Requisitos dos Projetos Analiticos"
authores: "Davi Almeida Ferreira e Guilherme Rocha Gomez"
date: "Julho de 2021"
output:
  html_document:
        code_folding: hide
        number_sections: no
        toc: yes
        toc_float:
            collapsed: yes
            smooth_scroll: yes
---
<left>

![](simbolo_fgv.png)

Turma: **FGV TBABD-8**  
Professor: **Rafael Lychowski**  
Autores: **Davi Almeida Ferreira** e **Guilherme Rocha Gomez** 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, warning = F, error = F)
```


### Metodologia utilizada

Utilizaremos para a realização deste trabalho a metodologia CRISP-DM

<center>

![](crisp-dm.png)

### Entendimento do Negócio

A Vale pretende prever o desgaste de rodas de vagões e fornecer uma visão futura da frota de rodeiros, para melhor planejamento de menutanção e compra de componentes. 

**Problema:** Prever se o friso da roda estaá abaixo de 26 mm na próxima leitura.

1. A área não tem visibilidade do que vai contecer com o ativos, antecipando as trocas;
2. A cada troca o rodeiro é usinado, e sua vida útil reduzida;
3. Incapacidade de visuzalização de desgastes acelerados em toda a frota de vagões
4. Muitos vagões apresentam reinciência de trocas, e os fatores não são bem claros;

* Base de dados: EFC_WAYSIDES.csv
* Variável dependente: ESPESSURA_FRISO_RODA
* Método: Supervisionado
* Submétodo: Classificação
* Objetivo: Identificar quais os frisos terão menos que 26 cm de friso no próximo ciclo.

### Entendimento dos Dados

```{r include=FALSE}
# Importar bibliotecas que serão utilizadas no trabalho

library(caret)
library(mlbench)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(kableExtra)
library(hrbrthemes)
library(viridis)
library(tseries)
library(ggfortify)

# Iniciar sessão do SPARK
# Separando as mehores configurações para os computadores que cada integrante do grupo usa.

#aluno <- "Guilherme"
aluno <- "Davi"

if (aluno == "Guilherme") {

spark_path <-'C:/Guilherme/spark'
if (nchar(Sys.getenv("SPARK_HOME")) < 1) {
  Sys.setenv(SPARK_HOME = spark_path)
}
library(SparkR, lib.loc = c(file.path(Sys.getenv("SPARK_HOME"), "R", "lib")))
sparkR.session(master = "local[*]", sparkConfig = 
list(spark.driver.memory = "1g"))

pathfile = "C:/Guilherme/FGV/Desafios e Requisitos dos Projetos Analiticos/EFC_WAYSIDES.csv"

}else{

library(SparkR)

spark_path <-"C:/spark-3.1.2-bin-hadoop3.2"
if (nchar(Sys.getenv("SPARK_HOME")) < 1) {
  Sys.setenv(SPARK_HOME = spark_path)
}
sparkR.session(master = "local[*]", sparkConfig = list(spark.driver.memory = "6g"))

pathfile <- "C:/trabalho-final-desafios/EFC_WAYSIDES.csv"
}

paste("Configuração para o computador do: ",aluno)

sqlContext <- sparkR.session(sc)
sparkR.conf()

```

```{r include=FALSE}
# Importar dataset 

# Utilizando o inferSchema muitos campos numéricos foram identificados com string.
schema <- structType(
  structField("ROW_ID", "string"),
  structField("DATA_HORA_LEITURA", "timestamp"),
  structField("CODIGO_VAGAO", "string"),
  structField("CODIGO_RODEIRO", "string"),
  structField("CODIGO_RODA", "string"),
  structField("LADO_RODA", "string"),
  structField("EIXO_VAGAO", "double"),
  structField("CICLO_RODEIRO", "string"),
  structField("TRAIN_ID", "string"),
  structField("SENTIDO_TREM", "string"),
  structField("VELOCIDADE_ENTRADA_TREM", "double"),
  structField("VELOCIDADE_SAIDA_TREM", "double"),
  structField("POSICAO_VAGAO_COMPOSICAO", "double"),
  structField("ANGULO_FRISO_RODA", "double"),
  structField("ALTURA_FRISO_RODA", "double"),
  structField("ESPESSURA_FRISO_RODA", "double"),
  structField("CAVA_RODA", "double"),
  structField("ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE", "double"),
  structField("ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE", "double"),
  structField("TRACKING_POSITION_EIXO_FRONTAL_TRUQUE", "double"),
  structField("TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE", "double"),
  structField("ROTACAO_EIXO", "double"),
  structField("ALINHAMENTO_ENTRE_EIXOS_(IAM)", "double"),
  structField("DESLOCAMENTO_ENTRE_EIXOS_(SHIFT)", "double"),
  structField("TRACKING_ERROR_(TE)", "double"),
  structField("SERPENTEAMENTO_(HUNTING)", "double"),
  structField("friso_baixo", "double")
)

df <- SparkR::read.df(path = pathfile,
                      header='true', 
                      source = "com.databricks.spark.csv", 
                      schema = schema,
                      na.strings = "")

head(df)
cache(df)


#Criando novas colunas pelo método mais comum.
df$friso_baixo <- SparkR::ifelse(df$ESPESSURA_FRISO_RODA<26,1,0)

#Criando novas colunas e escolhendo o tipo de dado usanod withColumn.
df <- df %>% 
  withColumn(.,"Dia",cast(df$DATA_HORA_LEITURA,"Date")) #%>% 
  #withColumn(.,"Dia",cast(df$DATA_HORA_LEITURA,"Date"))


df_sample <- df %>% sample(withReplacement = F,fraction = 0.0005)

#read.df(sqlContext,)

# Incluir o arquivo na memória para facilitar a interação
persist(df,"MEMORY_ONLY")

#cache(df) == persist(df,"MEMORY_ONLY")
#cacheTable(sqlContext,"tableNmae")

```

#### Verificação da qualidade dos Dados

```{r}
"Verificando o 'Schema' dos dados"
printSchema(df)

```

##### Verificar a existencia de dados faltantes


```{r include=FALSE}

#Visualizando uma amostra de dados
SparkR::head(df,32)
#dtypes(df)

#Verificando valores faltantes no df
ncol_df <- ncol(df)
ncol_df

columns(df)
col_name <- 0
is_Null <- 0
col_class <- 0

```


```{r, cache=TRUE}

#Verificando qualidade dos dados.

test_null <- function(coluna){
   try(df %>% where(.,isNull(.[[coluna]]))%>%count(.), silent = TRUE)}

test_isNAN <- function(coluna){
  try(df %>% where(.,isNaN(.[[coluna]]))%>%count(.), silent = TRUE)}

test_vazio <- function(coluna){
  try(df %>% where(.,.[[coluna]]== "")  %>% count(.), silent = TRUE)}

test_zero <- function(coluna){
  try(df %>% where(.,.[[coluna]]== 0)  %>% count(.), silent = TRUE)}

total <- count(df)

class(df$ROW_ID)

x <- 0
Tipo_de_dados <- 0

for (i in 1:length(colnames(df))){
  x[i] <- dtypes(df)[[i]][1]
  Tipo_de_dados[i] <- dtypes(df)[[i]][2]
}
tipo_dados <- as.data.frame(Tipo_de_dados,x)

cont_prob <- data.frame()
for (coluna in colnames(df)){
#As colunas no dataframe serão linhas neste relatório.
  
#  cont_prob[coluna,"Tipo"]  <- tipo_dados[coluna,y]
  cont_prob[coluna,"Nulo"]  <- ifelse(is.numeric(test_null(coluna)),test_null(coluna),0)
  cont_prob[coluna,"% Nulo"]  <- ifelse(is.numeric(test_null(coluna)),
                                        paste(round(((test_null(coluna)/total)*100),0),"%",sep=""),
                                        "0%")
  cont_prob[coluna,"isNAN"] <-    ifelse(is.numeric(test_isNAN(coluna)),test_isNAN(coluna),0)
  cont_prob[coluna,"% isNAN"]  <- ifelse(is.numeric(test_isNAN(coluna)),
                                        paste(round(((test_isNAN(coluna)/total)*100),0),"%",sep=""),
                                        "0%")
  cont_prob[coluna,"Vazio"] <- ifelse(is.numeric(test_vazio(coluna)),test_vazio(coluna),0)
  cont_prob[coluna,"% Vazio"]  <- ifelse(is.numeric(test_vazio(coluna)),
                                        paste(round(((test_vazio(coluna)/total)*100),0),"%",sep=""),
                                        "0%")
  cont_prob[coluna,"Zero"]  <- ifelse(is.numeric(test_zero(coluna)),test_zero(coluna),0)
  cont_prob[coluna,"% Zero"]  <- ifelse(is.numeric(test_zero(coluna)),
                                        paste(round(((test_zero(coluna)/total)*100),0),"%",sep=""),
                                        "0%")
}

cont_prob <- cbind(cont_prob,tipo_dados)

cont_prob %>% kable(., format = "html",row.names = T, digits = 2) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed","responsive")) 
```

##### Avaliando os dados nulos

###### CAVA_RODA, ANGULO_FRiSO_RODA 

CAVA_RODA: A variável com maior número de dados nulos foi a CAVA_RODA com 607.049 (20%) dados nulos. Com o objetivo de avaliar a estratégia de tratamento dos dados vamos realizar a distribuição de dados nulos em comparação com as outras variáveis.

ANGULO_FRISO_RODA: A segunda variável com maior número de dados nulos foi a ANGULO_FRISO_RODA com 287.408 (10%) dados nulos em comparação as outras variáveis.

```{r}

# Avaliando os dados nulos para CAVA_RODA, indentificando se ocorreu alguma data com maior numero de dados nulos.

df_null_CAVA_RODA <- where(df, isNull(df$CAVA_RODA))

nulos_CAVA_RODA <- count(df_null_CAVA_RODA)

perc_nulos_CAVA_RODA <- paste(round((nulos_CAVA_RODA/total)*100,0),"%",sep="")

perc_nulos_CAVA_RODA

# Avaliando os dados nulos para ANGULO_FRiSO_RODA, indentificando se ocorreu alguma data com maior numero de dados nulos.

df_null_ANGULO_FRISO_RODA <- where(df, isNull(df$ANGULO_FRISO_RODA))

nulos_ANGULO_FRISO_RODA <- count(df_null_ANGULO_FRISO_RODA)

perc_nulos_ANGULO_FRISO_RODA <- paste(round((nulos_ANGULO_FRISO_RODA/total)*100,0),"%",sep="")

perc_nulos_ANGULO_FRISO_RODA

# O percentual de dados faltando para CAVA_RODA é de 20%

gb_df_null_CAVA_RODA <- groupBy(df_null_CAVA_RODA, df_null_CAVA_RODA$Dia)

nNull_CAVA_RODA_by_DIA <- agg(gb_df_null_CAVA_RODA, Nulls_CAVA_RODA = n(df_null_CAVA_RODA$Dia))

nNull_CAVA_RODA_by_DIA.dat <- collect(nNull_CAVA_RODA_by_DIA)
nNull_CAVA_RODA_by_DIA.dat

CAVA_RODA_order_by_date <- nNull_CAVA_RODA_by_DIA.dat[order(nNull_CAVA_RODA_by_DIA.dat$Dia),]
CAVA_RODA_order_by_date

# O percentual de dados faltando para ANGULO_FRISO_RODA é de 10%

gb_df_null_ANGULO_FRISO_RODA <- groupBy(df_null_ANGULO_FRISO_RODA, df_null_ANGULO_FRISO_RODA$Dia)

nNull_ANGULO_FRISO_RODA_by_DIA <- agg(gb_df_null_ANGULO_FRISO_RODA, 
                                      Nulls_ANGULO_FRISO_RODA = n(df_null_ANGULO_FRISO_RODA$Dia))

nNull_ANGULO_FRISO_RODA_by_DIA.dat <- collect(nNull_ANGULO_FRISO_RODA_by_DIA)
nNull_ANGULO_FRISO_RODA_by_DIA.dat

ANGULO_FRISO_RODA_order_by_date <- nNull_ANGULO_FRISO_RODA_by_DIA.dat[order(nNull_ANGULO_FRISO_RODA_by_DIA.dat$Dia),]
ANGULO_FRISO_RODA_order_by_date

full <- full_join(CAVA_RODA_order_by_date,
                  ANGULO_FRISO_RODA_order_by_date,
                  by = NULL)
full

# Gráfico de Nulos CAVA_RODA por data

g_CAVA_RODA_order_by_date <- ggplot(CAVA_RODA_order_by_date, aes(x=Dia, y=Nulls))+
  geom_line(color="green")+
  ggtitle("Nulos em CAVA_RODA por dia")+
  xlab("Data (dias)")+
  ylab("Total de Nulos")+
  theme_dark()
g_CAVA_RODA_order_by_date

# Gráfico de Nulos ANGULO_FRISO_RODA por data

g_ANGULO_FRISO_RODA_order_by_date <- ggplot(ANGULO_FRISO_RODA_order_by_date, aes(x=Dia, y=Nulls))+
  geom_line(color="red")+
  ggtitle("Nulos em ANGULO_FRISO_RODA por dia")+
  xlab("Data (dias)")+
  ylab("Total de Nulos")+
  theme_dark()
g_ANGULO_FRISO_RODA_order_by_date

# Gráfico de Full

g_full <- ggplot(full, aes(x=Dia))+
  geom_line(aes(y=Nulls_CAVA_RODA),color="green")+
  geom_line(aes(y=Nulls_ANGULO_FRISO_RODA),color="red")+
  ggtitle("Nulos nas variáveis por dia")+
  xlab("Data (dias)")+
  ylab("Total de Nulos")+
  theme_dark()
g_full


```

###### ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE, ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE, TRACKING_POSITION_EIXO_FRONTAL_TRUQUE, TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE, ROTACAO_EIXO, ALINHAMENTO_ENTRE_EIXOS_(IAM), DESLOCAMENTO_ENTRE_EIXOS_(SHIFT) e TRACKING_ERROR_(TE)

Essas variáveis apresentam 19.723 (1%) de valores nulos

```{r}

# Avaliando os dados nulos para CAVA_RODA, indentificando se ocorreu alguma data com maior numero de dados nulos.

variaveis <- c("ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE",
"ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE"
,"TRACKING_POSITION_EIXO_FRONTAL_TRUQUE",
"TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE",
"ROTACAO_EIXO", 
"ALINHAMENTO_ENTRE_EIXOS_IAM", 
"DESLOCAMENTO_ENTRE_EIXOS_SHIFT", 
"TRACKING_ERROR_TE")

indice <- c(18,19,20,21,22,23,24,25)

nam <- 0
for(i in 1:length(variaveis)) { 
  nam <- paste("df_null_",variaveis[i],sep = "")
  assign(nam,
         df %>% where(., isNull(.[[indice[i]]])))
  print(nam)
  print(indice[i])
}

head(df_null_TRACKING_ERROR_TE)

#### PAREI AQUI

nulos_TRACKING_ERROR_TE <- count(df_null_TRACKING_ERROR_TE)
nulos_TRACKING_ERROR_TE

perc_TRACKING_ERROR_TE <- paste(round((nulos_CAVA_RODA/total)*100,0),"%",sep="")

perc_TRACKING_ERROR_TE

# O percentual de dados faltando para CAVA_RODA é de 20%

gb_df_null_CAVA_RODA <- groupBy(df_null_CAVA_RODA, df_null_CAVA_RODA$Dia)

nNull_CAVA_RODA_by_DIA <- agg(gb_df_null_CAVA_RODA, Nulls_CAVA_RODA = n(df_null_CAVA_RODA$Dia))

nNull_CAVA_RODA_by_DIA.dat <- collect(nNull_CAVA_RODA_by_DIA)
nNull_CAVA_RODA_by_DIA.dat

CAVA_RODA_order_by_date <- nNull_CAVA_RODA_by_DIA.dat[order(nNull_CAVA_RODA_by_DIA.dat$Dia),]
CAVA_RODA_order_by_date

full <- full_join(CAVA_RODA_order_by_date,
                  ANGULO_FRISO_RODA_order_by_date,
                  by = NULL)
full

# Gráfico de Full

g_full <- ggplot(full, aes(x=Dia))+
  geom_line(aes(y=Nulls_CAVA_RODA),color="green")+
  geom_line(aes(y=Nulls_ANGULO_FRISO_RODA),color="red")+
  ggtitle("Nulos nas variáveis por dia")+
  xlab("Data (dias)")+
  ylab("Total de Nulos")+
  theme_dark()
g_full


```

#### Identificar as principais estatisticas da Amostra


```{r}
sumstats1 <- describe(df, "EIXO_VAGAO",
                     "VELOCIDADE_ENTRADA_TREM",
                     "VELOCIDADE_SAIDA_TREM")
sumstats2 <- describe(df, "POSICAO_VAGAO_COMPOSICAO",
                     "ANGULO_FRISO_RODA",
                     "ALTURA_FRISO_RODA")
sumstats3 <- describe(df, "ESPESSURA_FRISO_RODA",
                     "CAVA_RODA",
                     "ROTACAO_EIXO")
sumstats4 <- describe(df, "ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE",
                     "ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE")
sumstats5 <- describe(df, "TRACKING_POSITION_EIXO_FRONTAL_TRUQUE")
sumstats6 <- describe(df, "TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE")
showDF(sumstats1)
showDF(sumstats2)
showDF(sumstats3)
showDF(sumstats4)
showDF(sumstats5)
showDF(sumstats6)
```


```{r echo=FALSE}
#Usando a função agg

agg(df, velo_entrada_avg = avg(df$VELOCIDADE_ENTRADA_TREM)) %>% head()
agg(df, velo_entrada_sd = sd(df$VELOCIDADE_ENTRADA_TREM)) %>% head()
agg(df, velo_entrada_var = var(df$VELOCIDADE_ENTRADA_TREM)) %>% head()
agg(df, velo_entrada_max = max(df$VELOCIDADE_ENTRADA_TREM)) %>% head()

agg(df, alt_friso_avg = avg(df$ESPESSURA_FRISO_RODA)) %>% head()
agg(df, alt_friso_sd = sd(df$ESPESSURA_FRISO_RODA)) %>% head()
agg(df, alt_friso_var = var(df$ESPESSURA_FRISO_RODA)) %>% head()
agg(df, alt_friso_max = max(df$ESPESSURA_FRISO_RODA)) %>% head()


#Usando agg com agregação
gb_sn <- groupBy(df, df$CODIGO_RODA)
df2 <- agg(gb_sn, friso_avg = avg(df$ESPESSURA_FRISO_RODA), count = n(df$ESPESSURA_FRISO_RODA))
head(df2)


```


#### Identificar as principais correlações entre os dados

```{r}
# Medindo a correlação entre ESPESSURA FRISO RODA E EIXO VAGAO
corr_EFR_EV <- corr(df, "ESPESSURA_FRISO_RODA", "EIXO_VAGAO")
corr_EFR_EV


```

#### Construir visualizações

Listados com top 10

```{r}

createOrReplaceTempView(df, "tabela")

sdf_vagao_trocas_roda <- sql("select
    CODIGO_VAGAO
    ,count(*) qtd

    from tabela
    where CODIGO_RODA != CICLO_RODEIRO
          and
          CODIGO_VAGAO in 
              (select
                  CODIGO_VAGAO
                      from tabela
                    where friso_baixo ==1
                    group by CODIGO_VAGAO)


    group by CODIGO_VAGAO
    order by qtd desc

    "
    
    )



sdf_vagao_trocas_roda_all <- sql(
"
  select
    *
  from
  tabela
  
  where CODIGO_VAGAO in
  (
  select
    CODIGO_VAGAO
    
      from tabela
    where CODIGO_RODA != CICLO_RODEIRO
          and
          CODIGO_VAGAO in 
              (select
                  CODIGO_VAGAO
                      from tabela
                    where friso_baixo ==1
                    group by CODIGO_VAGAO)


    group by CODIGO_VAGAO
  )
  
  "
)






lista_vagoes_troca_friso_baixo <- sdf_vagao_trocas_roda %>% head(1000)


vagoes <- lista_vagoes_troca_friso_baixo %>% head(10) %>% as.list()

myplots <- list()
n <- 1
for (vagao in vagoes$CODIGO_VAGAO){
  filtro_vagao <- vagao
  g1 <- 
    where(df,df$CODIGO_VAGAO==filtro_vagao)  %>%
    head(10000) %>%
    ggplot(aes(x=Dia, y=ESPESSURA_FRISO_RODA,color=CICLO_RODEIRO))+
    geom_point()+facet_wrap(~CODIGO_RODA,ncol = 2)+
    scale_y_continuous(limits = c(18,38))+
    geom_smooth()+
    geom_hline(yintercept=26, linetype="dashed", color = "red", size=1)+
    theme(legend.position="none")
  
  myplots[[n]] <- g1
  n <- n+1
  print(g1)
}



# where(df,df$CODIGO_VAGAO=='69632')%>%
#   collect(.)%>%
#   ggplot(aes(x=Dia, y=ESPESSURA_FRISO_RODA,color=CICLO_RODEIRO))+
#   geom_point()+facet_wrap(~CODIGO_RODA,ncol = 2)+
#   scale_y_continuous(limits = c(18,38))+
#   geom_smooth()+
#   geom_hline(yintercept=26, linetype="dashed", color = "red", size=1)+
#     theme(legend.position="none")



```

Listados com bottom 10

```{r}

vagoes <- lista_vagoes_troca_friso_baixo %>% tail(10) %>% as.list()

myplots <- list()
n <- 1
for (vagao in vagoes$CODIGO_VAGAO){
  filtro_vagao <- vagao
  g1 <- 
    where(df,df$CODIGO_VAGAO==filtro_vagao)  %>%
    head(10000) %>%
    ggplot(aes(x=Dia, y=ESPESSURA_FRISO_RODA,color=CICLO_RODEIRO))+
    geom_point()+facet_wrap(~CODIGO_RODA,ncol = 2)+
    scale_y_continuous(limits = c(18,38))+
    geom_smooth()+
    geom_hline(yintercept=26, linetype="dashed", color = "red", size=1)+
    theme(legend.position="none")
  
  myplots[[n]] <- g1
  n <- n+1
  print(g1)
}


```






```{r eval=FALSE, include=FALSE}
df_list <- randomSplit(sdf, c(7,3), 2)
df_train <- df_list[[1]]
df_test <- df_list[[2]]

#model <- spark.glm(df_train, ESPESSURA_FRISO_RODA ~., family = "gaussian")

# df_list <- randomSplit(sdf, c(7,3), 2)
# df_train <- df_list[[1]]
# df_test <- df_list[[2]]
# 
# model <- spark.glm(df_train, GENDER ~., family = "gaussian")
# 
# summary(model)
# 
# predictions_1 <- predict(model, df_train)
# local_df <- collect(predictions_1)
# p = local_df$label-local_df$prediction
# mse = mean((p)^2)
# mae = mean(abs(p))
# rmse = sqrt(mse)
# R2 = 1-(sum((p)^2)/sum((local_df$label-mean(local_df$label))^2))
# print("Métricas de avaliação da base de Treino")
# sprintf(" MAE: %.2f", mae)
# sprintf("MSE: %.2f", mse)
# sprintf("RMSE: %.2f", rmse)
# sprintf("R2: %.4f", R2)

```




```{r}


#sdf_RODEIRO_friso_baixo_all  %>% 
#where(df,df$CODIGO_VAGAO=='515276') %>% 

sdf_vagao_trocas_roda_all %>% 
 collect(.) %>% 
 ggplot( aes(x=as.character(Dia), y=ESPESSURA_FRISO_RODA, fill=as.character(Dia))) +
   geom_boxplot() +
   scale_fill_viridis(discrete = TRUE, alpha=0.6) +
   geom_jitter(color="black", size=0.05, alpha=0.05) +
   theme(
     legend.position="none",
     plot.title = element_text(size=11)
   ) +
   #scale_y_continuous(limits = c(0,100))+
   ggtitle("ESPESSURA_FRISO_RODA Dia") +
   xlab("")



```


### Preparação dos Dados




```{r}

df_sample %>% where(.,isNull(.[["ANGULO_FRISO_RODA"]]))%>% head(100) 
df_sample %>% where(.,!isNull(.[["ANGULO_FRISO_RODA"]]))%>% head(100)

grupo_angulo_null <- groupBy(df %>% where(.,isNull(.[["ANGULO_FRISO_RODA"]])), df$CODIGO_RODA)
df2 <- agg(grupo_angulo_null,count = n(df$CODIGO_RODA))
df2 %>% head(1000)
#Algumas rodas nunca tiveram medidas de ângulo
#(5054164RIGHT,0960614RIGHT,6083714RIGHT,0995294RIGHT,5534531LEFT,5519574RIGHT,0867584RIGHT,6346311RIGHT,0809114RIGHT,5599823RIGHT)
# O que fazer nestes casos?


#Exemplo de rodas com falta de dados e uma opção de completar com fill.

cbind(
df %>% 
  where(.,df$CODIGO_RODA %in%
c('0956094RIGHT','6241133RIGHT','0851232RIGHT','7011773RIGHT','0825071RIGHT','5519574RIGHT','5392051LEFT','6395011LEFT','9126664LEFT')) %>% 
  select('Dia','CODIGO_RODA','ANGULO_FRISO_RODA') %>%  
  arrange('CODIGO_RODA','Dia') %>% 
  head(10000)
,

df %>% 
  where(.,df$CODIGO_RODA %in%
c('0956094RIGHT','6241133RIGHT','0851232RIGHT','7011773RIGHT','0825071RIGHT','5519574RIGHT','5392051LEFT','6395011LEFT','9126664LEFT')) %>% 
  arrange('CODIGO_RODA','Dia') %>% 
    select('ANGULO_FRISO_RODA') %>%  
  withColumnRenamed('ANGULO_FRISO_RODA','downup') %>% 
  head(10000) %>% 
  fill('downup', .direction = "downup")

,

df %>% 
  where(.,df$CODIGO_RODA %in%
c('0956094RIGHT','6241133RIGHT','0851232RIGHT','7011773RIGHT','0825071RIGHT','5519574RIGHT','5392051LEFT','6395011LEFT','9126664LEFT')) %>% 
  arrange('CODIGO_RODA','Dia') %>% 
    select('ANGULO_FRISO_RODA') %>%   
  withColumnRenamed('ANGULO_FRISO_RODA','up') %>% 
  head(10000) %>% 
  fill('up', .direction = "up")



,

df %>% 
  where(.,df$CODIGO_RODA %in%
c('0956094RIGHT','6241133RIGHT','0851232RIGHT','7011773RIGHT','0825071RIGHT','5519574RIGHT','5392051LEFT','6395011LEFT','9126664LEFT')) %>% 
  arrange('CODIGO_RODA','Dia') %>% 
    select('ANGULO_FRISO_RODA') %>%  
  withColumnRenamed('ANGULO_FRISO_RODA','down') %>% 
  head(10000) %>% 
  fill('down', .direction = "down")


)



df_sample %>% where(.,isNull(.[["ALTURA_FRISO_RODA"]]))%>% head(100) 
df_sample %>% where(.,isNull(.[["ESPESSURA_FRISO_RODA"]]))%>% head(100)
df_sample %>% where(.,isNull(.[["CAVA_RODA"]]))%>% head(100)



# As medidas do TBOGIE parecem falhar pelo mesma razão para todas as medidas.

# ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE       
# ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE      
# TRACKING_POSITION_EIXO_FRONTAL_TRUQUE   
# ROTACAO_EIXO                            
# ALINHAMENTO_ENTRE_EIXOS_(IAM)           
# DESLOCAMENTO_ENTRE_EIXOS_(SHIFT)        
# TRACKING_ERROR_(TE)                     
# SERPENTEAMENTO_(HUNTING)  

#df_sample %>% where(.,isNaN(.[["ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE"]])) %>% head(100) %>% View()
#df_sample %>% where(.,.[["ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE"]]== "")  %>% head(100) %>% View()
#df_sample %>% where(.,.[["ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE"]]== 0)  %>% head(100) %>% View()


```



#### Normalizaçao?
#### PCA/Redução de dimensionalidade

### Modelagem

#### Classificação
##### Regressão logística
##### Árvore de decisão
##### Redes neurais
##### Ensemble?

### Avaliação

### Conclusão

