---
title: "Desafios e Requisitos dos Projetos Analiticos"
authores: "Davi Almeida Ferreira e Guilherme Rocha Gomez"
date: "Julho de 2021"
output:
  html_document:
        code_folding: hide
        number_sections: no
        toc: yes
        toc_float:
            collapsed: yes
            smooth_scroll: yes
---
<left>

![](simbolo_fgv.png)

Turma: **FGV TBABD-8**  
Professor: **Rafael Lychowski**  
Autores: **Davi Almeida Ferreira** e **Guilherme Rocha Gomez** 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, warning = F, error = F)
```

### Metodologia utilizada

Utilizaremos para a realização deste trabalho a metodologia CRISP-DM

<center>

![](crisp-dm.png)

### Entendimento do Negócio

A Vale pretende prever o desgaste de rodas de vagões e fornecer uma visão futura da frota de rodeiros, para melhor planejamento de menutanção e compra de componentes. 

**Problema:** Prever se o friso da roda estaá abaixo de 26 mm na próxima leitura.

1. A área não tem visibilidade do que vai contecer com o ativos, antecipando as trocas;
2. A cada troca o rodeiro é usinado, e sua vida útil reduzida;
3. Incapacidade de visuzalização de desgastes acelerados em toda a frota de vagões
4. Muitos vagões apresentam reinciência de trocas, e os fatores não são bem claros;

* Base de dados: EFC_WAYSIDES.csv
* Variável dependente: ESPESSURA_FRISO_RODA
* Método: Supervisionado
* Submétodo: Classificação
* Objetivo: Identificar quais os frisos terão menos que 26 cm de friso no próximo ciclo.

### Entendimento dos Dados

```{r include=FALSE}
# Importar bibliotecas que serão utilizadas no trabalho

library(caret)
library(mlbench)
library(dplyr)
library(tidyverse)
library(SparkR)

# Iniciar sessão do SPARK

spark_path <-"C:/spark-3.1.2-bin-hadoop3.2"
if (nchar(Sys.getenv("SPARK_HOME")) < 1) {
  Sys.setenv(SPARK_HOME = spark_path)
}
sparkR.session(master = "local[*]", sparkConfig = list(spark.driver.memory = "6g"))

sqlContext <- sparkR.session(sc)
sparkR.conf()

```

```{r}
# Importar dataset 

pathfile <- "C:/trabalho-final-desafios/EFC_WAYSIDES.csv"

df <- SparkR::read.df(path = pathfile,
                      header='true', 
                      source = "com.databricks.spark.csv", 
                      inferSchema='true',
                      na.strings = "")

head(df)
cache(df)
#read.df(sqlContext,)

# Incluir o arquivo na memória para facilitar a interação
persist(df,"MEMORY_ONLY")

#cache(df) == persist(df,"MEMORY_ONLY")
#cacheTable(sqlContext,"tableNmae")

```

#### Verificação da qualidade dos Dados

```{r}
"Verificando o 'Schema' dos dados"
printSchema(df)

```

##### Verificar a existencia de dados faltantes

```{r include=FALSE}

#Visualizando uma amostra de dados
SparkR::head(df,32)
#dtypes(df)

#Verificando valores faltantes no df
ncol_df <- ncol(df)
ncol_df

columns(df)
col_name <- 0
is_Null <- 0
col_class <- 0

# "ROW_ID" "int""
df_ROW_ID_Null <- where(df, isNull(df$ROW_ID))

# "DATA_HORA_LEITURA" "string"" -> Date
df_DATA_HORA_LEITURA_Null <- where(df, df$DATA_HORA_LEITURA=="")

# "CODIGO_VAGAO" "int"" -> String
df_CODIGO_VAGAO_Null <- where(df, isNull(df$CODIGO_VAGAO))

# "CODIGO_RODEIRO" "int" -> String         
df_CODIGO_RODEIRO_Null <- where(df, isNull(df$CODIGO_RODEIRO))

# "CODIGO_RODA" "string"  
df_CODIGO_RODA_Null <- where(df, df$CODIGO_RODEIRO=="")

# "LADO_RODA" "string"       
df_LADO_RODA_Null <- where(df, df$LADO_RODA=="")

# "EIXO_VAGAO" "int"       
df_EIXO_VAGAO_Null <- where(df, isNull(df$EIXO_VAGAO))

# "CICLO_RODEIRO" "string"       
df_CICLO_RODEIRO_Null <- where(df, df$CICLO_RODEIRO=="")

# "TRAIN_ID" "string"  
df_TRAIN_ID_Null <- where(df, df$TRAIN_ID=="")

# "SENTIDO_TREM" "string"      
df_SENTIDO_TREM_Null <- where(df, df$SENTIDO_TREM=="")

# "VELOCIDADE_ENTRADA_TREM" "int"                    
df_VELOCIDADE_ENTRADA_TREM_Null <- where(df, isNull(df$VELOCIDADE_ENTRADA_TREM))

# "VELOCIDADE_SAIDA_TREM" "int"                  
df_VELOCIDADE_SAIDA_TREM_Null <- where(df, isNull(df$VELOCIDADE_SAIDA_TREM))

# "POSICAO_VAGAO_COMPOSICAO" "int"                     
df_POSICAO_VAGAO_COMPOSICAO_Null <- where(df, isNull(df$POSICAO_VAGAO_COMPOSICAO))

# "ANGULO_FRISO_RODA" "string" -> int           
df_ANGULO_FRISO_RODA_Null <- where(df, df$ANGULO_FRISO_RODA=="")

# "ALTURA_FRISO_RODA" "string" -> int           
df_ALTURA_FRISO_RODA_Null <- where(df, df$ALTURA_FRISO_RODA=="")

# "ESPESSURA_FRISO_RODA" "string" - int       
df_ESPESSURA_FRISO_RODA_Null <- where(df, df$ESPESSURA_FRISO_RODA=="")

# "CAVA_RODA" "string" - int   
df_CAVA_RODA_Null <- where(df, df$CAVA_RODA=="")

# "ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE" "string" - int
df_ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE_Null <- where(df, df$ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE=="")

# "ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE" "string" - int
df_ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE_Null <- where(df, df$ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE=="")

# "TRACKING_POSITION_EIXO_FRONTAL_TRUQUE" "string" - int
df_TRACKING_POSITION_EIXO_FRONTAL_TRUQUE_Null <- where(df, df$TRACKING_POSITION_EIXO_FRONTAL_TRUQUE=="")

# "TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE" "string" - int
df_TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE_Null <- where(df, df$TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE=="")

# "ROTACAO_EIXO" "string" - int
df_ROTACAO_EIXO_Null <- where(df, df$ROTACAO_EIXO=="")

# "ALINHAMENTO_ENTRE_EIXOS_IAM" "string" - int                       
df_ALINHAMENTO_ENTRE_EIXOS_IAM_Null <- where(df, df$`ALINHAMENTO_ENTRE_EIXOS_(IAM)`=="")

# "DESLOCAMENTO_ENTRE_EIXOS_(SHIFT)" "string" - int                          
df_DESLOCAMENTO_ENTRE_EIXOS_SHIFT_Null <- where(df, df$`DESLOCAMENTO_ENTRE_EIXOS_(SHIFT)`=="")

# "TRACKING_ERROR_(TE)" "string" - int
df_TRACKING_ERROR_TE_Null <- where(df, df$`TRACKING_ERROR_(TE)`=="")

# "SERPENTEAMENTO_(HUNTING)" "int"                   
df_SERPENTEAMENTO_HUNTING_Null <- where(df, df$`SERPENTEAMENTO_(HUNTING)`=="")

col_names <- columns(df)

is_null <- c(count(df_ROW_ID_Null),
             count(df_DATA_HORA_LEITURA_Null),
             count(df_CODIGO_VAGAO_Null),
             count(df_CODIGO_RODEIRO_Null),
             count(df_CODIGO_RODA_Null),
             count(df_LADO_RODA_Null),
             count(df_EIXO_VAGAO_Null),
             count(df_CICLO_RODEIRO_Null),
             count(df_TRAIN_ID_Null),
             count(df_SENTIDO_TREM_Null),
             count(df_VELOCIDADE_ENTRADA_TREM_Null),
             count(df_VELOCIDADE_SAIDA_TREM_Null),
             count(df_POSICAO_VAGAO_COMPOSICAO_Null),
             count(df_ANGULO_FRISO_RODA_Null),
             count(df_ALTURA_FRISO_RODA_Null),
             count(df_ESPESSURA_FRISO_RODA_Null),
             count(df_CAVA_RODA_Null),
             count(df_ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE_Null),
             count(df_ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE_Null),
             count(df_TRACKING_POSITION_EIXO_FRONTAL_TRUQUE_Null),
             count(df_TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE_Null),
             count(df_ROTACAO_EIXO_Null),
             count(df_ALINHAMENTO_ENTRE_EIXOS_IAM_Null),
             count(df_DESLOCAMENTO_ENTRE_EIXOS_SHIFT_Null),
             count(df_TRACKING_ERROR_TE_Null),
             count(df_SERPENTEAMENTO_HUNTING_Null))

data_type_after <- 0
for (i in 1:ncol_df){
  data_type_after[i] <- dtypes(df)[[i]][2]
  print(dtypes(df)[[i]][2])
}

analise_das_variaveis <- data.frame(col_names, is_null, data_type_after)
colnames(analise_das_variaveis) <- c("Variável",
"Qtd de dados Nulos", "Tipo de dado antes")
analise_das_variaveis
```

```{r table}
knitr::kable(analise_das_variaveis, caption = "Análise preliminar das variáveis do problema")
```

##### Ajustar os dados estão com o tipo incorreto

```{r}
# Variáveis que necessitam de transformação

# "DATA_HORA_LEITURA" "string"" -> Date
# "CODIGO_VAGAO" "int"" -> String
# "CODIGO_RODEIRO" "int" -> String   
# "ANGULO_FRISO_RODA" "string" -> Int
# "ALTURA_FRISO_RODA" "string" -> int  
# "ESPESSURA_FRISO_RODA" "string" - int  
# "CAVA_RODA" "string" - int  
# "ANGULO_ATAQUE_EIXO_FRONTAL_TRUQUE" "string" - "int"  
# "ANGULO_ATAQUE_EIXO_TRASEIRO_TRUQUE" "string" - int
# "TRACKING_POSITION_EIXO_FRONTAL_TRUQUE" "string" - int
# "TRACKING_POSITION_EIXO_TRASEIRO_TRUQUE" "string" - int
# "ROTACAO_EIXO" "string" - int

```

##### Verificar outliers
##### Eliminar redundancias

#### Identificar as principais estatisticas da Amostra
#### Identificar as principais correlações entre os dados
#### Construir visualizações

```{r}

printSchema(df)

df %>% head()
df %>% nrow()
df_sample <- df %>% sample(withReplacement = F,fraction = 0.0005)


rdf <- collect(df_sample)

collect(df_sample) %>% 
  #mutate(friso_baixo=ifelse(ESPESSURA_FRISO_RODA<26,"Baixo","OK"))%>% 
  ggplot(aes(x=ESPESSURA_FRISO_RODA,y=CAVA_RODA))+
  geom_point()

#Nomeando uma tabela
createOrReplaceTempView(df, "tabela")

#Não será executada a consulta
sdf <- sql("SELECT DATA_HORA_LEITURA  FROM tabela limit 1000")

#Para ter as primeiras linhas
SparkR::head(sdf)

#Para executar toda a consulta
#O resultado será um datafra em R. Ou seja, aqui fazemos uma "conversão".
#collect(sdf)



df_list <- randomSplit(sdf, c(7,3), 2)
df_train <- df_list[[1]]
df_test <- df_list[[2]]

#model <- spark.glm(df_train, ESPESSURA_FRISO_RODA ~., family = "gaussian")




# collect(df)
# 
# DataExplorer::plot_intro(
#   df, 
#   ggtheme = theme_bw(),
#   theme_config = theme(legend.position = "bottom")
# )
# 
# 
# library(visdat)
# df %>% 
# vis_dat( sort_type = TRUE,warn_large_data = FALSE)


df %>% select("CODIGO_RODEIRO") %>% head()



# df_list <- randomSplit(sdf, c(7,3), 2)
# df_train <- df_list[[1]]
# df_test <- df_list[[2]]
# 
# model <- spark.glm(df_train, GENDER ~., family = "gaussian")
# 
# summary(model)
# 
# predictions_1 <- predict(model, df_train)
# local_df <- collect(predictions_1)
# p = local_df$label-local_df$prediction
# mse = mean((p)^2)
# mae = mean(abs(p))
# rmse = sqrt(mse)
# R2 = 1-(sum((p)^2)/sum((local_df$label-mean(local_df$label))^2))
# print("Métricas de avaliação da base de Treino")
# sprintf(" MAE: %.2f", mae)
# sprintf("MSE: %.2f", mse)
# sprintf("RMSE: %.2f", rmse)
# sprintf("R2: %.4f", R2)

```


### Preparação dos Dados

#### Normalizaçao?
#### PCA/Redução de dimensionalidade

### Modelagem

#### Classificação
##### Regressão logística
##### Árvore de decisão
##### Redes neurais
##### Ensemble?

### Avaliação

### Conclusão

